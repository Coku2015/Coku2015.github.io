<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automation | Backup next cloud</title><meta name=keywords content><meta name=description content="2017年起，我陆续在微信公众号上开始发一些关于数据保护的话题，总感觉在公众号上的内容查询历史存档和内容并不是那么方便，于是决定将这些内容完整的整理一个博客网站，以后的内容我会在本站和微信公众号上同时发布。"><meta name=author content="Lei Wei"><link rel=canonical href=https://newblog.backupnext.cloud/tags/automation/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2d6dbfc6e0f8a1db1c9d082a76dc11d094328cf63f247bbc2421dfaa7f2bb170.css integrity="sha256-LW2/xuD4odscnQgqdtwR0JQyjPY/JHu8JCHfqn8rsXA=" rel="preload stylesheet" as=style><link rel=icon href=https://newblog.backupnext.cloud/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://newblog.backupnext.cloud/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://newblog.backupnext.cloud/favicon-32x32.png><link rel=apple-touch-icon href=https://newblog.backupnext.cloud/apple-touch-icon.png><link rel=mask-icon href=https://newblog.backupnext.cloud/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><link rel=alternate type=application/rss+xml href=https://newblog.backupnext.cloud/tags/automation/index.xml><meta property="og:title" content="Automation"><meta property="og:description" content="2017年起，我陆续在微信公众号上开始发一些关于数据保护的话题，总感觉在公众号上的内容查询历史存档和内容并不是那么方便，于是决定将这些内容完整的整理一个博客网站，以后的内容我会在本站和微信公众号上同时发布。"><meta property="og:type" content="website"><meta property="og:url" content="https://newblog.backupnext.cloud/tags/automation/"><meta property="og:site_name" content="Backup next Cloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automation"><meta name=twitter:description content="2017年起，我陆续在微信公众号上开始发一些关于数据保护的话题，总感觉在公众号上的内容查询历史存档和内容并不是那么方便，于是决定将这些内容完整的整理一个博客网站，以后的内容我会在本站和微信公众号上同时发布。"></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://newblog.backupnext.cloud/ accesskey=h title="Lei Wei's blog (Alt + H)">Lei Wei's blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://newblog.backupnext.cloud/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://newblog.backupnext.cloud/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://newblog.backupnext.cloud/search/ title=Search><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>Automation</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>使用vSphere PowerCLI快速完成Veeam备份管理员角色创建</h2></header><section class=entry-content><p>为Veeam定制一个最小化的vSphere权限账号对于系统管理安全来说非常有必要，但是随着软件的升级功能的增强，对于vSphere上需要用到的权限也越来越多，Veeam在官方的UserGuide中提到了详细的细颗粒度权限要求，此时如果手工去逐个比对、选择，其实还是挺费时挺麻烦的一件事情。
最近我看到一个非常不错的PowerCLI脚本，使用这个脚本能够快速方便的创建这个Veeam专用角色，今天来和大家分享一下。
这个脚本的前提条件，是安装vSphere PowerCLI，脚本是通过VMware自动化的vSphere PowerCLI管理工具来实现的。安装方法在VMware官网的Blog中有详细说明，我这里给个简化版的步骤：
首先下载安装PowerShell Core 7，这是PowerCLI运行的必要条件。PowerShell Core比Windows PowerShell更强大，不熟悉的朋友也可以通过下载链接进去了解详细。安装过程非常简单，如果是Windows下，.MSI安装包双击后跟着向导就能装完。
打开PowerShell 7快捷方式后，运行以下命令来安装vSphere PowerCLI。
Install-Module -Name VMware.PowerCLI -Scope CurrentUser 安装完成后输入以下命令，能够看到如下结果：
Get-Module -Name VMware.* -ListAvailable 3. 运行这个PS脚本，运行过程中会提示输入vCenter的IP地址、用户名密码以及希望创建的角色名称，根据实际情况输入即可。运行结果如下图：
回到vSphere Client，找到Administration下的Access Control，在Roles下面，能够找到刚刚用脚本创建出来的VBR Backup Admin的角色。接下去就可以去创建Veeam专用用户了。 在Administration的最底部，找到Single Sign On下面的Users and Groups，在Users下面，把Domain切换成vSphere登录的Domain，然后Add User添加新用户。 添加完用户后，回到vCenter节点，授权这个新用户访问指定的vCenter，并给予VBR Backup Admin的权限，如下图： 以上就是快速简单的添加备份角色的方法，安全又可靠，脚本链接如下： https://github.com/falkobanaszak/vCenter-role-for-Veeam/blob/master/New_vCenterRole_Veeam.ps1</p></section><footer class=entry-footer>Lei Wei</footer><a class=entry-link aria-label="post link to 使用vSphere PowerCLI快速完成Veeam备份管理员角色创建" href=https://newblog.backupnext.cloud/post/2020-06-05-powercli-vsphere-permission/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>数据集成API真的就只是API？</h2></header><section class=entry-content><p>Veeam发布v10之后，推出了一个全新的功能，但是这个功能深深的埋藏在了Powershell API之下，并且被冠了一个令人高不可攀的名称：数据集成API。我相信很多朋友看完这个名字，就可能不太想了解这个功能。对于系统管理员来说，有点略复杂了，还要开发什么东西才能把这个用起来？算了还是不用了。
功能 其实这个功能并不是那么的复杂，我们先来了解下怎么回事。
这个功能其实是通过iSCSI的磁盘服务，将备份存档通过iSCSI发布给相关服务器使用。它是数据利用的新形态，也就是说任何的Veeam的镜像级备份存档，都可以通过这种形式挂载给服务器去访问里面的数据。它和即时虚拟机恢复有那么一点点像，但是完全不一样的是，它完全不依赖于虚拟化环境，不依赖VMware和Hyper-V，而是将数据直接通过iSCSI服务发布给Windows或者Linux系统访问。在VBR中，绝大多数镜像级的备份存档都支持这种形式的发布：
VMware镜像级备份 VMware镜像级复制 Hyper-V镜像级备份 Hyper-V镜像级复制 Veeam Agent for Windows的镜像级备份 Veeam Agent for Linux的镜像级备份 原理 iSCSI挂载的工作原理非常简单，在API发起后，VBR的挂载服务器相当于变成一台iSCSI的存储机头，它能为所有可以访问iSCSI存储的系统提供iSCSI的服务，而这里面提供出去的数据则是VBR的存档，管理员可以按需从备份或复制存档中选择需要的数据。在这个数据集成服务建立起来后，数据使用者可以通过iSCSI的存储协议，直接挂载发布出来的卷，读取其中的数据，使用其中的数据。如图所示，在数据集成服务将备份存档发布后，备份系统变成了一套iSCSI的存储系统，里面存放的数据是之前的历史备份数据。
使用方法 因为它以API形式开放给用户使用，因此在VBR控制台上并没有直接的按钮来使用，但是这完全挡不住我们使用这么优秀的功能。可以直接使用本文最后面的这个Powershell的脚本来实现这个功能，需要做的很简单，只要copy脚本内容到记事本，存成.ps1文件，然后在VBR服务器的Powershell控制台中执行这个交互式脚本即可，按照脚本执行过程中的提示输入必要的信息就能成功将存档通过iSCSI发布出来了。
执行脚本后，会看到Powershell控制台上输入内容后会看到以下效果：
而此时，在VBR上会看到发布出来的磁盘信息，它以Instant Recovery显示在VBR控制台中。
接下来，我们可以来到iSCSI客户端上，比如刚刚在脚本执行时输入IP地址的机器10.10.1.175上，打开Windows的iSCSI Initiator，填入iSCSI的target为10.10.1.201，端口默认3260，来挂载这个iSCSI卷了。
在使用结束后，不要忘了在VBR上点击Stop Publishing来回收这个iSCSI卷。
以上就是简单实用的新功能，iSCSI发布。赶紧下载VBR装上试一下吧。
附上脚本：
# 本脚本是Veeam DataIntegration API的使用样例 # 用于通过iSCSI方式将备份数据挂载给指定的系统进行使用 # 使用脚本需要至少有7个还原点以上，否则请修改脚本使用 # 脚本暂时仅限VMware、Hyper-V的主备份存档，如需Agent、Backup Copy、Replication、Storage Snapshot，请根据需求修改脚本。 # # 脚本作者：Wei Lei # Email:lei.wei@veeam.com # 脚本版本：v1.1 ################# Update log ###################### # 更新了VBR用户名密码错误后立刻停止脚本； # 更新了还原点选择错误后，自动终止脚本； ################################################### # Script Start # VBR Server (Server Name, FQDN or IP) $vbrServer = Read-Host "请输入VBR地址，可以是域名或者IP" # VBR Credentials Write-Host "请在弹出对话框中输入VBR的用户名密码。" $Credential=Get-Credential -Message 请输入VBR的用户名密码 $vbrusername = $Credential....</p></section><footer class=entry-footer>Lei Wei</footer><a class=entry-link aria-label="post link to 数据集成API真的就只是API？" href=https://newblog.backupnext.cloud/post/2020-07-13-data-integration-api/></a></article></main><footer class=footer><span>Copyright Lei Wei</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>